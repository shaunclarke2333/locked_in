// Defining variable globally so it is availbale to the entire pipeline.
def gv

pipeline {

    agent any

    /*
    To define environmental variables in your jenkins file.
    You must do it at the beginning of the pipeline block, this allows it to be available for all stages in that pipeline.
     you define environment variablkes like this

     environment {
        NEW_VERSION = '1.2.0'

        //environment variable for credentials. make sure the "Credentials binding plugin" that supports it is installed
        The credentials function takes the id of the credentials that were already created in the GUI
        SERVER_CREDENTIALS = credentials('credential-id')
     }

     We can also define environment variable in a sepcific stage using:
     withCredentials([
        usernamePassword(credentials: 'credential-id foes here', usernameVariable: User, passwordVariable: PASSWORD)
     ]) {
        // passing the username and pasword tot eh script
        sh "some_scrit_here ${USER} ${PW}"
     }

    */

    // Defining an environment variable
    environment {
        NEW_VERSION = '1.2.0'
     }

    stages {
        // This stage imports a groovy script and make all the functions defined in them available
        stage("init") {
            steps {
                script {
                    gv = load "java-maven-app/script.groovy"
                }
            }
        }
        stage("build") {

            //expression for running build stage if branch name is dev and code changes were made
            // when {
            //     expression {
            //         BRANCH_NAME == 'dev' && CODE_CHANGES ==true
            //     }
            // }
            
            steps {
                script {
                    gv.appBuild()
                }
            }
        }
        stage("test") {
             /*
            To define expressions or conditionals for each stage.
            You would use "when" expressions and  add it to the beginning of the stage block.
            Let's say you only wanted to run tests on dev or prod branch.
            Or if you want to run build stage if it is dev branch and and code changes were made.
            It would look like this.
            expression for running test stage if branch name is dev or master
            when {
                expression {
                    BRANCH_NAME == 'dev' || BRANCH_NAME == 'master'
                }
            }
            expression for running build stage if branch name is dev and code changes were made
            when {
                expression {
                    BRANCH_NAME == 'dev' && CODE_CHANGES ==true
                }
            }
            */

            //expression for running test stage if branch name is dev or master
            // when {
            //     expression {
            //         BRANCH_NAME == 'dev' || BRANCH_NAME == 'master'
            //     }
            // }

            steps {
                script {
                    gv.appTest()
                }
            }
        }
        stage("deploy") {

            steps {
                script {
                    gv.appDeploy()
                }
            }
        }
    }

    post {

        /*
        In this stage/block you can add logic that should run after all stages are completed
        For example the post section is like the finally block in a try catch finally.
        You can have the following conditions in post that will trigger what you want to execute.

        always {
            always execute whatever is in here regardless of the job outcome
        }

        success {
            Only execute when the job is successful
        }

        failure {
            Only execute if the job failed
        }
        */

         success {
            // Only execute when the job is successful
            echo "Job completed successfully"
        }

        failure {
            // Only execute if the job failed
            echo "Job failed"
        }

    }
}